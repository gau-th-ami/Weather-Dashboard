<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Weather </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="searchBar">
        <div class="searchBarParentDiv">
            <input type="text" class="inputfield" placeholder="Search City">
            <img src="images/Searchicon.jpg" alt="Search image" width="28px" class="searchIcon" onclick="fetchData()">
        </div>

    </div>
    <div class="mainContentParentDiv d-flex">
        <div class="leftDiv">
            <div class="currentTempDiv leftChild p-3 d-flex flex-column gap-2">
                <h6 class="m-0" id="cityName">City Name</h6>
                <h5 class="m-0"><span id="cityTemp">0</span>  &deg;C </h5>
                <h6 class="m-0" id="skyDesc">Sky Description</h6>
                <hr class="line">
                <div class="d-flex gap-2">
                    <img src="images/calendar.png" alt="calendar" width="25px">
                    <h6 class="m-0" id="date">Date</h6>
                </div>
                <div class="d-flex gap-2">
                    <img src="images/clock.png" alt="clock" width="25px">
                    <h6 class="m-0" id="time">Time</h6>
                </div>

            </div>
            <div class="nextFiveDays leftChild p-3 d-flex flex-column gap-2">
                <h6 class="m-0 " id="comingFiveDaysTitle">Coming 5 Days</h6>
                <div class="d-flex flex-column gap-1">
                    <div class="forecastRow d-flex align-items-center justify-content-between">
                        <div class="d-flex gap-1 align-items-center">
                            <img src="images/cloud.png" alt="cloud" width="35px">
                            <h6 class="m-0">7 &deg;C</h6>
                        </div>
                        <h6 class="m-0">Saturday</h6>
                        <h6 class="m-0">08-03-2025</h6>
                    </div>
                    <div class="forecastRow d-flex align-items-center justify-content-between">
                        <div class="d-flex gap-1 align-items-center">
                            <img src="images/cloud.png" alt="cloud" width="35px">
                            <h6 class="m-0">7 &deg;C</h6>
                        </div>
                        <h6 class="m-0">Saturday</h6>
                        <h6 class="m-0">08-03-2025</h6>
                    </div>
                    <div class="forecastRow d-flex align-items-center justify-content-between">
                        <div class="d-flex gap-1 align-items-center">
                            <img src="images/cloud.png" alt="cloud" width="35px">
                            <h6 class="m-0">7 &deg;C</h6>
                        </div>
                        <h6 class="m-0">Saturday</h6>
                        <h6 class="m-0">08-03-2025</h6>
                    </div>
                    <div class="forecastRow d-flex align-items-center justify-content-between">
                        <div class="d-flex gap-1 align-items-center">
                            <img src="images/cloud.png" alt="cloud" width="35px">
                            <h6 class="m-0">7 &deg;C</h6>
                        </div>
                        <h6 class="m-0">Saturday</h6>
                        <h6 class="m-0">08-03-2025</h6>
                    </div>
                    <div class="forecastRow d-flex align-items-center justify-content-between">
                        <div class="d-flex gap-1 align-items-center">
                            <img src="images/cloud.png" alt="cloud" width="35px">
                            <h6 class="m-0">7 &deg;C</h6>
                        </div>
                        <h6 class="m-0">Saturday</h6>
                        <h6 class="m-0">08-03-2025</h6>
                    </div>
                </div>
            </div>
        </div>

        <div class="rightDiv">
            <div class="rightRow rowOne d-flex gap-2 justify-content-between align-items-center">
                <div class="extraMetric d-flex gap-3">
                    <img src="images/wind.png" alt="wind" width="35px">
                    <div>
                        <h6 class="m-0" id="windMetricName">Metric Name</h6>
                        <h6 class="m-0" id="windMetricValue">Metric Value</h6>
                    </div>

                </div>
                <div class="extraMetric d-flex gap-3">
                    <img src="images/wind.png" alt="wind" width="35px">
                    <div>
                        <h6 class="m-0" id="humidityMetricName">Metric Name</h6>
                        <h6 class="m-0" id="humidityMetricValue">Metric Value</h6>
                    </div>

                </div>
                <div class="extraMetric d-flex gap-3">
                    <img src="images/wind.png" alt="wind" width="35px">
                    <div>
                        <h6 class="m-0" id="pressureMetricName">Metric Name</h6>
                        <h6 class="m-0" id="pressureMetricValue">Metric Value</h6>
                    </div>

                </div>
                <div class="extraMetric d-flex gap-3">
                    <img src="images/wind.png" alt="wind" width="35px">
                    <div>
                        <h6 class="m-0" id="visibilityMetricName">Metric Name</h6>
                        <h6 class="m-0" id="visibilityMetricValue">Metric Value</h6>
                    </div>

                </div>
            </div>


            <div class="rightRow rowTwo d-flex justify-content-between align-items-center">
                <div class="AQI rowTwoDiv p-3 d-flex flex-column gap-2">
                    <h5>Air Quality Index (AQI)</h5>
                     
                    <div class="d-flex align-items-center gap-4">
                        <img src="images/weather.png" alt="wind" width="40px">
                        <div class="text-center">
                            <h6 id="co">AQI METRIC </h6>
                            <h6 id="coValue">0</h6>
                        </div>
                        <div class="text-center">
                            <h6 id="so2">AQI METRIC </h6>
                            <h6 id="so2Value">0</h6>
                        </div>
                        <div class="text-center">
                            <h6 id="o3">AQI Metric </h6>
                            <h6 id="o3Value">0</h6>
                        </div>
                        <div class="text-center">
                            <h6 id="no2">AQI Metric </h6>
                            <h6 id="no2Value">0</h6>
                        </div>
                    </div>
                </div>
                <div class="sunRise rowTwoDiv p-3 gap-2 w-auto mx-auto">
                    <h5 class="m-0">Sunrise & Sunset</h5>
                    <div class="d-flex justify-content-start">
                    <div class="sunriseDiv d-flex gap-2 align-items-center">
                        <img src="images/clear-sky.png" alt="sun" width="50px">
                        <div class="d-flex flex-column gap-1">
                            <h6 class="m-0">Sunrise</h6>
                            <h5 class="m-0" id="sunriseTime">6:00 Am</h5>
                        </div>
                    </div>
                    <div class="sunsetDiv d-flex gap-2 align-items-center ms-5">
                        <img src="images/moon (2).png" alt="moon" width="50px">
                        <div class="d-flex flex-column gap-1">
                            <h6 class="m-0">Sunset</h6>
                            <h5 class="m-0" id="sunsetTime">7:00Pm</h5>
                        </div>
                    </div>
                   </div>
                </div>
            </div>



            <div class="rightRow rowThree d-flex flex-column gap-2">
                <h5 class="m-0">Today</h5>
                <div class="d-flex gap-5 todayTempParentDiv">
                    <div class="todayTemp">
                        <h6 class="m-0">9:00 Am</h6>
                        <img src="images/cloudyyy.png" alt="cloudy" width="35px">
                        <h5>15 &deg;C</h5>
                    </div>
                    <div class="todayTemp">
                        <h6 class="m-0">9:00 Am</h6>
                        <img src="images/cloudyyy.png" alt="cloudy" width="35px">
                        <h5>15 &deg;C</h5>
                    </div>
                    <div class="todayTemp">
                        <h6 class="m-0">9:00 Am</h6>
                        <img src="images/cloudyyy.png" alt="cloudy" width="35px">
                        <h5>15 &deg;C</h5>
                    </div>
                    <div class="todayTemp">
                        <h6 class="m-0">9:00 Am</h6>
                        <img src="images/cloudyyy.png" alt="cloudy" width="35px">
                        <h5>15 &deg;C</h5>
                    </div>
                    <div class="todayTemp">
                        <h6 class="m-0">9:00 Am</h6>
                        <img src="images/cloudyyy.png" alt="cloudy" width="35px">
                        <h5>15 &deg;C</h5>
                    </div>
                    <div class="todayTemp">
                        <h6 class="m-0">9:00 Am</h6>
                        <img src="images/cloudyyy.png" alt="cloudy" width="35px">
                        <h5>15 &deg;C</h5>
                    </div>
                </div>
            </div>
        </div>

    </div>






    <script src="config.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>
    <script src="main.js"></script>
    <script>
        function formatDate(timestamp, timezoneOffset) 
        {
            let utcMillis = timestamp * 1000;
            let localMillis = utcMillis + (timezoneOffset * 1000);

            let date = new Date(localMillis);

            return date.toLocaleDateString("en-US", {
                weekday: "long",
                year: "numeric",
                month: "short",
                day: "numeric",
                timeZone: "UTC"
            });

        }
        function formatTime(timestamp, timezoneOffset)
        {
            let utcMillis = timestamp * 1000;
            let localMillis = utcMillis + (timezoneOffset * 1000);

            let date = new Date(localMillis);
            return date.toLocaleTimeString("en-US", {
                hour: "2-digit",
                minute: "2-digit",
                hour12: true,
                timeZone: "UTC"
            });
        }

        async function fetchAQIData(lat,lon)
        {
            let res = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}`)
            let formattedData = await res.json();
            console.log('AQI Data: ',formattedData);
            let list=formattedData.list[0].components;
            
            $("#co").text("CO");
            $("#coValue").text(list.co);

            $("#no2").text("NO2");
            $("#no2Value").text(list.no2);

            $("#o3").text("O3");
            $("#o3Value").text(list.o3);

            $("#so2").text("SO2");
            $("#so2Value").text(list.so2);

            // 2. Fetch Weather data
            let weatherData = await fetchWeatherData(lat, lon);
            // 3. Update Weather Metrics
            const weatherMetrics = 
            {
            wind: { name: "Wind Speed", value: weatherData.wind.speed + " m/s" },
            humidity: { name: "Humidity", value: weatherData.main.humidity + " %" },
            pressure: { name: "Pressure", value: weatherData.main.pressure + " hPa" },
            visibility: { name: "Visibility", value: (weatherData.visibility / 1000) + " km" }
            };
            $("#windMetricName").text(weatherMetrics.wind.name);
            $("#windMetricValue").text(weatherMetrics.wind.value);

            $("#humidityMetricName").text(weatherMetrics.humidity.name);
            $("#humidityMetricValue").text(weatherMetrics.humidity.value);

            $("#pressureMetricName").text(weatherMetrics.pressure.name);
            $("#pressureMetricValue").text(weatherMetrics.pressure.value);

            $("#visibilityMetricName").text(weatherMetrics.visibility.name);
            $("#visibilityMetricValue").text(weatherMetrics.visibility.value);
        }

        async function fetchWeatherData(lat, lon) 
        {
            let res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`);
            let weatherData = await res.json();
            return weatherData;
        }

        async function fetchFiveDayForecast(lat, lon) 
        {
            let res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`);
            let data = await res.json();
            console.log("5-Day Forecast Data: ", data);

            let timezoneOffset = data.city.timezone;

            // Group by day (pick forecast around 12:00 PM each day)
            let dailyForecast = {};
            data.list.forEach(item => 
            {
                let date = new Date((item.dt + timezoneOffset) * 1000).toISOString().split("T")[0]; // YYYY-MM-DD
                let hour = new Date((item.dt + timezoneOffset) * 1000).getUTCHours();

                if ((hour >= 11 && hour <= 14) && !dailyForecast[date]) 
                {
                    dailyForecast[date] = item;
                }
            });

            // Convert to array & limit 5 days
            let forecastArray = Object.values(dailyForecast).slice(0, 5);

            // Clear existing rows
            $(".nextFiveDays .d-flex.flex-column.gap-1").empty();

            forecastArray.forEach(day => 
            {
                let date = new Date((day.dt + timezoneOffset) * 1000);
                let weekday = date.toLocaleDateString("en-US", { weekday: "long" });
                let fullDate = date.toLocaleDateString("en-GB"); // DD/MM/YYYY
                let temp = Math.round(day.main.temp);
                let icon = day.weather[0].icon;

                $(".nextFiveDays .d-flex.flex-column.gap-1").append(`
                    <div class="forecastRow d-flex align-items-center justify-content-between">
                       <div class="d-flex gap-1 align-items-center">
                          <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="weather" width="35px">
                          <h6 class="m-0">${temp} &deg;C</h6>
                        </div>
                        <h6 class="m-0">${weekday}</h6>
                        <h6 class="m-0">${fullDate}</h6>
                    </div>
               `);
            });
        }
        async function fetchTodayForecast(lat, lon) 
        {
            let res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`);
            let data = await res.json();
            console.log("Today's Forecast Data: ", data);

            let timezoneOffset = data.city.timezone;

            // Filter only today’s data
            let todayDate = new Date((data.list[0].dt + timezoneOffset) * 1000).toISOString().split("T")[0];
            let todayData = data.list.filter(item => 
            {
                let date = new Date((item.dt + timezoneOffset) * 1000).toISOString().split("T")[0];
                return date === todayDate;
            });

            // Limit to next 6 time slots (around 3-hour intervals)
            todayData = todayData.slice(0, 6);

            // Clear old data
            $(".todayTempParentDiv").empty();

            todayData.forEach(item => 
            {
                let time = formatTime(item.dt, timezoneOffset);
                let temp = Math.round(item.main.temp);
                let icon = item.weather[0].icon;

                $(".todayTempParentDiv").append(`
                    <div class="todayTemp text-center">
                        <h6 class="m-0">${time}</h6>
                        <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="weather" width="35px">
                        <h5>${temp} &deg;C</h5>
                    </div>
                `);
            });
        }


        async function fetchData()
        {
            let cityName = document.getElementsByClassName('inputfield')[0].value;
            let requestData = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${cityName}&appid=${API_KEY}&units=metric`)
            let formattedData= await requestData.json();
            console.log("Formatted Data: ", formattedData);

            if (formattedData.cod !== 200) {
                alert("city not found!");
                return;
            }
            $('#cityName').text(formattedData.name);
            $("#cityTemp").text(formattedData.main.temp);
            $("#skyDesc").text(formattedData.weather[0].description);

            
            let timezoneOffset = formattedData.timezone;

            // Fix date and time
            $("#date").text(formatDate(formattedData.dt, timezoneOffset));//full date
            $("#time").text(formatTime(formattedData.dt, timezoneOffset));//only time

            //Fix sunrise and sunset
            $("#sunriseTime").text(formatTime(formattedData.sys.sunrise, timezoneOffset));
            $("#sunsetTime").text(formatTime(formattedData.sys.sunset, timezoneOffset));


            //AQI
            let lat = formattedData.coord.lat;
            let lon = formattedData.coord.lon;
            fetchAQIData(lat, lon);
            fetchFiveDayForecast(lat, lon);
            fetchTodayForecast(lat, lon);
        }
    </script>

    <script>
        // Array of background images
        const backgrounds = 
        [
            "images/snow.jpg",
            "images/rainy.jpg",
            "images/night.jpg",
            "images/cloudy.jpg"
        ];

        // Pick a random one
        const randomBg = backgrounds[Math.floor(Math.random() * backgrounds.length)];

        // Apply to body
        document.body.style.backgroundImage = `url('${randomBg}')`;
        document.body.style.backgroundSize = "cover";
        document.body.style.backgroundPosition = "center";
        document.body.style.backgroundRepeat = "no-repeat";
        document.body.style.backgroundAttachment = "fixed";
    </script>

  </body>
</html>